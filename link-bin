#!/usr/bin/env bash

set -euo pipefail

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
src_dir="$repo_root/scripts"
bin_dir="$HOME/bin"

mkdir -p "$bin_dir"

# remove links that only point to the current repo
# 1) check if link is a symlink otherwise continue
# 2) read the symlink
# 3) if the link starts with src_dir (is a script of the repo) remove it
printf '%s\n' "step: unlink repo symlinks"
removed_count=0
for link in "$bin_dir"/*; do
    [ -L "$link" ] || continue
    target="$(readlink "$link")"
    case "$target" in
    "$src_dir"/*)

        rm -f "$link"
        printf '%s\n' "unlink: $link -> $target"
        removed_count=$((removed_count + 1))
        ;;
    esac
done
printf '%s\n' "unlinked: $removed_count"

# create the links
# 1) iterate over all the files under the scripts directory
# 2) check the first line of every files
# 3) if the file starts with '#!/usr/bin/env bash' then symlink, otherwise continue
printf '\n%s\n' "step: link bash scripts"
linked_count=0
while IFS= read -r -d '' script; do
    IFS= read -r first <"$script" || continue
    if [[ "$first" == "#!/usr/bin/env bash" ]]; then
        script_name=$(basename "$script")
        chmod +x "$script"
        ln -sfn "$script" "$bin_dir/$script_name"
        printf '%s\n' "link: $bin_dir/$script_name -> $script"
        linked_count=$((linked_count + 1))
    fi
done < <(find "$src_dir" -type f -print0)

printf '%s\n' "linked: $linked_count"
printf '%s\n' "done: linked scripts to $bin_dir"
