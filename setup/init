#!/usr/bin/env bash

detect_source_path() {
    if [[ -n "${BASH_SOURCE[0]:-}" ]]; then
        printf "%s\n" "${BASH_SOURCE[0]}"
        return 0
    fi

    if [[ -n "${ZSH_VERSION:-}" ]]; then
        printf "%s\n" "${(%):-%x}"
        return 0
    fi

    printf "%s\n" "$0"
}

set_project_dir() {
    local source_path
    source_path="$(detect_source_path)"
    if [[ -z "$source_path" || "$source_path" == "zsh" || "$source_path" == "bash" ]]; then
        if [[ -n "${PWD:-}" && -f "$PWD/setup/init" ]]; then
            source_path="$PWD/setup/init"
        else
            printf "setup/init: unable to determine PROJECT_DIR\n" >&2
            return 1
        fi
    fi

    if [[ "$source_path" != /* ]]; then
        source_path="$PWD/$source_path"
    fi

    PROJECT_DIR="$(cd "$(dirname "$source_path")/.." && pwd)"
    export PROJECT_DIR
}

ensure_bin_path() {
    bin_dir="$PROJECT_DIR/bin"
    if [[ ! -d "$bin_dir" ]]; then
        mkdir -p "$bin_dir"
    fi

    case ":$PATH:" in
    *":$bin_dir:"*) ;;
    *)
        PATH="$bin_dir:$PATH"
        ;;
    esac

    export PATH
}

link_scripts() {
    bin_dir="$PROJECT_DIR/bin"

    if [[ -d "$bin_dir" ]]; then
        while IFS= read -r -d '' link; do
            target="$(readlink "$link" 2>/dev/null || true)"
            case "$target" in
            "$PROJECT_DIR"/modules/*/scripts/* | "$PROJECT_DIR"/scripts/*)
                rm -f "$link"
                ;;
            esac
        done < <(find "$bin_dir" -maxdepth 1 -type l -print0)
    fi

    if [[ -d "$PROJECT_DIR/modules" ]]; then
        while IFS= read -r -d '' script; do
            IFS= read -r first <"$script" || continue
            case "$first" in
            '#!'*)
                chmod +x "$script" 2>/dev/null || true
                script_name="$(basename "$script")"
                ln -sfn "$script" "$bin_dir/$script_name"
                ;;
            esac
        done < <(find "$PROJECT_DIR/modules" -type f -path '*/scripts/*' -print0)
    fi

    if [[ -d "$PROJECT_DIR/scripts" ]]; then
        while IFS= read -r -d '' script; do
            IFS= read -r first <"$script" || continue
            case "$first" in
            '#!'*)
                chmod +x "$script" 2>/dev/null || true
                script_name="$(basename "$script")"
                ln -sfn "$script" "$bin_dir/$script_name"
                ;;
            esac
        done < <(find "$PROJECT_DIR/scripts" -type f -print0)
    fi
}

source_functions() {
    if [[ ! -d "$PROJECT_DIR/modules" ]]; then
        return 0
    fi

    while IFS= read -r -d '' func_file; do
        IFS= read -r first <"$func_file" || continue
        case "$first" in
        '#!'*)
            # shellcheck source=/dev/null
            . "$func_file"
            ;;
        esac
    done < <(find "$PROJECT_DIR/modules" -type f -path '*/functions/*' ! -name '*.md' -print0)
}

source_aliases() {
    if [[ -d "$PROJECT_DIR/modules" ]]; then
        while IFS= read -r -d '' alias_file; do
            # shellcheck source=/dev/null
            . "$alias_file"
        done < <(find "$PROJECT_DIR/modules" -type f -name 'aliases.sh' -print0)
    fi

    if [[ -d "$PROJECT_DIR/modules" ]]; then
        while IFS= read -r -d '' alias_file; do
            # shellcheck source=/dev/null
            . "$alias_file"
        done < <(find "$PROJECT_DIR/modules" -type f -name 'aliases' -print0)
    fi

    if [[ -n "${BASH_VERSION:-}" && -d "$PROJECT_DIR/modules" ]]; then
        while IFS= read -r -d '' alias_file; do
            # shellcheck source=/dev/null
            . "$alias_file"
        done < <(find "$PROJECT_DIR/modules" -type f -name '.bash_aliases' -print0)
    elif [[ -n "${ZSH_VERSION:-}" && -d "$PROJECT_DIR/modules" ]]; then
        while IFS= read -r -d '' alias_file; do
            # shellcheck source=/dev/null
            . "$alias_file"
        done < <(find "$PROJECT_DIR/modules" -type f -name '.zsh_aliases' -print0)
    fi
}

main() {
    if ! set_project_dir; then
        return 1
    fi

    ensure_bin_path
    link_scripts
    source_functions
    source_aliases

}

main "$@"
