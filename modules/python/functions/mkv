#!/usr/bin/env bash

mkv() {
    local venv_name=""
    local status=0
    local extra_message=""

    local usage='usage: mkv [NAME]

create a python virtual env in the current directory

examples:
    mkv
    mkv venv
    mkv my_env'

    while [[ $# -gt 0 ]]; do
        case "$1" in
        -h | --help)
            {
                if [[ -n "$extra_message" ]]; then
                    printf "%s\n\n" "$extra_message"
                fi
                printf "%s\n" "$usage"
            } >&2
            return 0
            ;;
        -*)
            extra_message="unknown option: $1"
            {
                if [[ -n "$extra_message" ]]; then
                    printf "%s\n\n" "$extra_message"
                fi
                printf "%s\n" "$usage"
            } >&2
            return 2
            ;;
        *)
            if [[ -n "$venv_name" ]]; then
                extra_message="too many arguments: $1"
                {
                    if [[ -n "$extra_message" ]]; then
                        printf "%s\n\n" "$extra_message"
                    fi
                    printf "%s\n" "$usage"
                } >&2
                return 2
            fi
            venv_name="$1"
            ;;
        esac
        shift
    done

    if [[ -z "$venv_name" ]]; then
        venv_name="venv"
    fi

    if ! command -v python3 >/dev/null 2>&1; then
        extra_message="python3 not found in PATH"
        {
            if [[ -n "$extra_message" ]]; then
                printf "%s\n\n" "$extra_message"
            fi
            printf "%s\n" "$usage"
        } >&2
        return 127
    fi

    if ! python3 -m venv -h >/dev/null 2>&1; then
        extra_message="python3 venv module not available (try installing python3-venv)"
        {
            if [[ -n "$extra_message" ]]; then
                printf "%s\n\n" "$extra_message"
            fi
            printf "%s\n" "$usage"
        } >&2
        return 1
    fi

    if [[ -e "$venv_name" ]]; then
        extra_message="directory already exists: $venv_name"
        {
            if [[ -n "$extra_message" ]]; then
                printf "%s\n\n" "$extra_message"
            fi
            printf "%s\n" "$usage"
        } >&2
        return 2
    fi

    if ! python3 -m venv "$venv_name"; then
        status=$?
        return "$status"
    fi

    # shellcheck source=/dev/null
    source "$venv_name/bin/activate"
}
