#!/usr/bin/env bash

vrun() {
    local venv_name=""
    local venv_dir=""

    local usage='usage: vrun [NAME]

activate a python virtual env in the current directory

examples:
    vrun
    vrun venv
    vrun my_env'

    while [[ $# -gt 0 ]]; do
        case "$1" in
        -h | --help)
            printf "%s\n" "$usage" >&2
            return 0
            ;;
        -*)
            {
                printf "unknown option: %s\n\n" "$1"
                printf "%s\n" "$usage"
            } >&2
            return 2
            ;;
        *)
            if [[ -n "$venv_name" ]]; then
                {
                    printf "too many arguments: %s\n\n" "$1"
                    printf "%s\n" "$usage"
                } >&2
                return 2
            fi
            venv_name="$1"
            ;;
        esac
        shift
    done

    if [[ -z "$venv_name" ]]; then
        venv_name="venv"
    fi

    venv_dir="$venv_name"

    if [[ ! -d "$venv_dir" ]]; then
        {
            printf "directory not found: %s\n\n" "$venv_dir"
            printf "%s\n" "$usage"
        } >&2
        return 2
    fi

    if [[ ! -f "$venv_dir/bin/activate" ]]; then
        {
            printf "activation script not found: %s/bin/activate\n\n" "$venv_dir"
            printf "%s\n" "$usage"
        } >&2
        return 1
    fi

    # shellcheck source=/dev/null
    if ! source "$venv_dir/bin/activate"; then
        local exit_status=$?
        {
            printf "failed to activate venv: %s\n\n" "$venv_dir"
            printf "%s\n" "$usage"
        } >&2
        return "$exit_status"
    fi
}
